<!DOCTYPE html>
<meta charset="utf-8" />
<style>
</style>
<script src='https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.4.2/js-yaml.min.js'></script>  

<textarea id="inputtext"></textarea>
<button>RUN</button>
<!-- <textarea id="outputtext"></textarea> -->
<pre><code id="outputtext"></code></pre>

<script>
const text = `
openapi: "3.0.2"
info:
  title: "サンプル"
  description: >-
    ほげ
    ふー
  version: "1.0.0"
externalDocs:
  description: "設計資料"
  url: "https://example.com"
tags:
  - name: 'update'
    description: '更新'
  - name: 'refer'
    description: '参照'
servers:
  - url: 'https://sample.com/v1'
    description: 'server'

paths:
  /request:
    post:
      summary: "依頼する"
      description: ""
      tags:
        - update
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - user_id
                - notification_url
                - service_name
              properties:
                user_id:
                  '\$ref': '#/components/schemas/UserId'
                notification_url:
                  type: string
                  description: 通知先URL
                service_name:
                  type: string
                  description: "サービス名"
      responses:
        200: 
          description: "正常"
          content:
            'application/json':
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: ID
                  member_init_state:
                    type: string
                    description: 会員状態
        x-異常-会員がいない:
          description: "会員状態の更新に失敗"

  /refer:
    post:
      summary: "参照する"
      description: ""
      tags:
        - refer
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - user_id
              properties:
                user_id:
                  $ref: '#/components/schemas/UserId'
      responses:
        200: 
          description: "リストで返す"

components:
  schemas:
    UserId:
      description: ユーザID
      type: "string"
`.trim();

function has(rootObj, cb) {
	try {
		return cb(rootObj)
	} catch {
		return false;
	}
}




const input = document.querySelector('#inputtext').value = text;
document.querySelector('button').addEventListener('click', () => {

	function getRef(ref) {
		return ref.split('/').slice(1).reduce((memo, v) => {
			return memo[v];
		}, swagger)
	}

	function expandRefs(obj) { // TODO 全階層にrefがないことを確認する
		if(obj['$ref']) {
			const refObj = getRef(obj['$ref']);
			Object.keys(refObj).forEach(key => {
				if(!obj[key]) {
					obj[key] = refObj[key];
				}
			});
			delete obj['$ref']
		}
		return obj;
	}

	function jsonObj2Table(obj, upper, text) {
		console.log(text === undefined, upper, text);
		if(text === undefined) {
			text = 'path | 型 | 説明\n';
			text += '---|---|---\n';
		}
		if(upper === undefined) {
			upper = '$'
		}

		if(obj.type == 'object') {
			text += `\`${upper}\` | ${obj.type} | ${obj.description || ''}\n`;
			text = Object.keys(obj.properties).reduce((memo, key) => {
				return jsonObj2Table(obj.properties[key], `${upper}.${key}`, memo);
			}, text)
		} else {
			text += `\`${upper}\` | ${obj.type} | ${obj.description || ''}\n`;
		}
		
		return text;
	}

	const input = document.querySelector('#inputtext').value.trim();
	var swagger = jsyaml.load(input);
	console.log(swagger);
	
	var output = '';

	// タイトル
	output += `# ${swagger.info.title}  \n`
	output += `${swagger.info.description}  \n`

	// 外部ドキュメント
	if(swagger.externalDocs) {
		output += `## 外部ドキュメント\n`
		output += `[${swagger.externalDocs.description}](${swagger.externalDocs.url})  \n\n`
	}

	// サーバ
	if(swagger.servers) {
		output += `## サーバ\n`
		swagger.servers.forEach(v => {
			output += `${v.url}  \n${v.description}\n\n`
		})
		
	}

	// paths
	output += `## PATH\n`
	output += Object.keys(swagger.paths).map(path => {
		return Object.keys(swagger.paths[path]).map(method => {
			const obj = swagger.paths[path][method]
			var output = `### ${method} ${path} ${obj.summary}\n`

			if(obj.description) {
				output += `${obj.description}\n\n`
			}

			if(obj.tags) {
				output += `tags: ${obj.tags.join(', ')}\n\n`
			}

			var schema = has(obj ,v => v.requestBody.content['application/x-www-form-urlencoded'].schema);
			if(schema !== false) {
				output += `#### リクエスト\n`
				output += `application/x-www-form-urlencoded  \n\n`
				let isRequired = (key) => {
					if(!schema.required) {
						return false;
					}
					return schema.required.filter(v => v == key).length > 0;
				}
				const headerKeys = ['キー', '必須', '説明']
				output += headerKeys.join(' | ') + '\n'
				output += headerKeys.map(v => '---').join('|') + '\n'
				output += Object.keys(schema.properties).map(key => {
					// refの中身を展開する
					var obj = schema.properties[key];
					obj = expandRefs(obj);
					
					obj.key = key;
					return obj;
				}).map(v => `\`${v.key.split('_').join('\_')}\` | ${isRequired(v.key) ? 'o':''} | ${v.description}`).join('\n')
				output += '\n\n'
			}

			output += `#### レスポンス\n`
			output += Object.keys(obj.responses).map(res => {
				var o = `##### ${res}\n`;
				o += `${obj.responses[res].description}\n`
				let schema = has(obj.responses[res], (v)=> v.content['application/json'].schema)
				if(schema !== false) {
					schema = expandRefs(schema);
					o += '\n'
					o += jsonObj2Table(schema)
				}
				o += `\n`
				return o;
				
			}).join('\n')

			return output;
		}).join('')
	}).join('')

	// ネストを1つあげる
	output = output.split('## ').join('# ');

	document.querySelector('#outputtext').innerText = output;
})
</script>